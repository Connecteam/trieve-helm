apiVersion: batch/v1
kind: CronJob
metadata:
  name: word-id-cronjob
  labels:
    app.kubernetes.io/name: word-id-cronjob
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  schedule: "0 0 * * *"
  concurrencyPolicy: Replace
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ .Values.gcloud.serviceAccountName }}
          restartPolicy: OnFailure
          containers:
          - name: set-ids-job
            image: {{ printf "%s:%s" "trieve/word-id-cronjob" .Values.containers.word_id_cronjob.tag }}
            envFrom:
              - configMapRef:
                  name: trieve-server-config
          {{- if eq $.Values.environment "gcloud" }}
          - name: cloud-sql-proxy
            # It is recommended to use the latest version of the Cloud SQL Auth Proxy
            # Make sure to update on a regular schedule!
            image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
            args:
              - "--structured-logs"
              - "--auto-iam-authn"
              # Replace DB_PORT with the port the proxy should listen on
              - "--port=5432"
              - {{ .Values.gcloud.cloudSqlProxyName }}
            securityContext:
              # The default Cloud SQL Auth Proxy image runs as the
              # "nonroot" user and group (uid: 65532) by default.
              runAsNonRoot: true
            # You should use resource requests/limits as a best practice to prevent
            # pods from consuming too many resources and affecting the execution of
            # other pods. You should adjust the following values based on what your
            # application needs. For details, see
            # https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
            resources:
              requests:
                # The proxy's memory use scales linearly with the number of active
                # connections. Fewer open connections will use less memory. Adjust
                # this value based on your application's requirements.
                memory: "100Mi"
                # The proxy's CPU use scales linearly with the amount of IO between
                # the database and the application. Adjust this value based on your
                # application's requirements.
                cpu:    "10m"
          {{- end }}
